---
title: "Directory of individual deaths, summarized by event"
output:
  html_document:
    df_print: tibble
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(datawizard) # putting first because of conflicts/masking
library(googlesheets4)
library(googledrive)
library(tidyr)
library(readr)
library(dplyr)
library(stringr)
library(reactable)
library(RColorBrewer)
library(forcats)

```

```{r import-settings, echo=FALSE, include=FALSE}
# Use "src/00-import-settings-live.R" to live-import from Google Sheets
# Use "src/00-import-settings-local.R" to load the most-updated local file
#
# These can be put in the chunk heading as file="src/00-import-settings-local.R",
# or in the body of the chunk as source("filename", local = knitr::knit_global()),
# but source() seems to behave better
library(here)

source(here::here("src","00-import-settings-local.R"), local = knitr::knit_global())
```

```{r import, echo=FALSE, include=FALSE}
source(here::here("src","01-import.R"), local = knitr::knit_global())

de.imported <- de

# filter the entries for:
# unconfirmed deaths
# collateral deaths
# nonconflict accident deaths
def <- de %>%
  filter(is.na(unconfirmed) | unconfirmed != TRUE) %>%
  filter(is.na(intentionality) | intentionality != "Collateral") %>%
  filter(is.na(intentionality) | !str_detect(intentionality, "Nonconflict"))

de.confirmed <- def

# de <- def # AUTOFILTERING. Comment out when we want to consider the whole dataset
          # Also, eventually we may want to handle "unconfirmed" in a more complex way
          #   At that point, we will no longer filter for it, but pass it through.

# Narrow filter leaves in unconfirmed events to be labeled below.
de <- de %>% 
  filter(is.na(intentionality) | intentionality != "Collateral") %>%
  filter(is.na(intentionality) | !str_detect(intentionality, "Nonconflict"))
```

```{r factoring, include=FALSE}
source(here::here("src","03-factoring-standard.R"), local = knitr::knit_global())
# This call accomplishesâ€¦
#
## Factoring: Presidential administration
# Creates global variables: president_levels, president_initials
#
## Factoring: State perpetrator (a quasilogical variable)
# Factored into five simplified levels
# "Unknown", "No", "Indirect", "Mutiny", "Yes"
#
## Factoring: State responsibility (a categorical variable)
# Factored into six simplified levels
# sr_levels <- c("Perpetrator", "Victim", "Involved", "Separate", "Unintentional", "Unknown")
# Color set: state_resp.colors
#
# If the call is made to "03-factoring-verbose.R" and has "include=TRUE", 
# will return summary tabyl's for the refactored variables..
```

```{r calculate-event-table, echo=FALSE, message=FALSE, warning=FALSE}
# create an event count by title that also counts the number of state perpetrator 
#   and state victim deaths
#
source(here::here("src","event-responsibility-dated.R"), local = knitr::knit_global())

event.responsibility <- event_responsibilty_summary_table(de) # for ALL deaths
```

```{r event_table, include=FALSE, message=FALSE, results='asis'}
source(here::here("src","event-responsibility-reactables.R"), local = knitr::knit_global())

standard_event_responsibility_reactable(event.responsibility)

cat("Categories of deaths may not add to the total because conflict accidents are excluded. \n\n")
cat(paste(datafiles_footer(),sep=""))
```

### Chronological view of events and deaths

This table can be ordered by any of its variables and searched by the text variables as well as the year. At the bottom you can choose how many events to show, or page through the events.

Using the triangles at left, you can access the individual deaths.

```{r drill-down-table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(lubridate)
library(reactable)
library(reactablefmtr)

event.responsibility <- event.responsibility %>% arrange(date)

de <- de %>% mutate(intentionality = case_when(
                                     unconfirmed == TRUE ~ str_c(intentionality, " (unconfirmed)"),
                                     TRUE ~ intentionality))

nested_event_responsibility_reactable(event.responsibility, de)
cat(paste(datafiles_footer(),sep=""))
```